@using Npgsql;
@using BlazorApp.Services
@inject ICookie cookie

<div class="top-row ps-3 navbar navbar-dark">
    <h3>SONARE</h3>
</div>

<input type="checkbox" title="Navigation menu" class="navbar-toggler" />

<div class="nav-scrollable" onclick="document.querySelector('.navbar-toggler').click()">
    <div class="nav-container">
        <nav class="flex-column">
            <div class="nav-item px-3">
                <NavLink class="nav-link" href="" Match="NavLinkMatch.All">
                    <span class="bi bi-house-door-fill-nav-menu" aria-hidden="true"></span> Home
                </NavLink>
            </div>

            <div class="nav-item px-3">
                <NavLink class="nav-link" href="products">
                    <span class="bi bi-basket2-fill-nested-nav-menu" aria-hidden="true"></span> Browse Products
                </NavLink>
            </div>
            @if (status == "logged_on")
            {
                <div class="nav-item px-3">
                    <NavLink class="nav-link" href="createlisting">
                        <span class="bi bi-plus-circle-fill-nested-nav-menu" aria-hidden="true"></span> Create Listing
                    </NavLink>
                </div>
            }

        </nav>

        <div class="nav-register-buttons">
            <button class="login-button"><div class="nav-item px-3"><NavLink class="nav-link" href="login">LOGIN</NavLink></div></button>
            <button class="register-button"><div class="nav-item px-3"><NavLink class="nav-link" href="createuser">REGISTER</NavLink></div></button>
        </div>
    </div>
</div>

@code
{
    private string? status { get; set; }

    private async Task LoadUserProfileAsync()
    {
        string connectionString = "Host=ep-blue-fire-a2nnh5p7.eu-central-1.aws.neon.tech;Username=sonaredb_owner;Password=8LlUVraRtDs9;Database=sonaredb;SSL Mode=Require";

        using var connection = new NpgsqlConnection(connectionString);
        await connection.OpenAsync(); // Async opening of the connection

        using (var cmd = new NpgsqlCommand())
        {
            cmd.Connection = connection;

            // Retrieve the id from the cookie
            int userId = int.Parse(await cookie.GetValue("id"));

            cmd.CommandText = @"
                SELECT status
                FROM useraccount
                WHERE id = @id";

            cmd.Parameters.AddWithValue("@id", userId);

            using (var reader = await cmd.ExecuteReaderAsync())
            {
                if (await reader.ReadAsync())
                {
                    status = reader.GetString(reader.GetOrdinal("status"));
                }
                else
                {
                    // To-do - handle if user not found
                }
            }
        }
    }
}
